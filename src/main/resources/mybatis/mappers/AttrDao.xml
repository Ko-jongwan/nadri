<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.nadri.attr.dao.AttrDao">

	<resultMap id="AttrResultMap" type="com.nadri.attr.vo.Attraction">
		<id column="att_no" property="no"/>
		<result column="att_name" property="name"/>
		<result column="att_content" property="content"/>
		<result column="att_startdate" property="startDate"/>
		<result column="att_enddate" property="endDate"/>
		<result column="att_place" property="place"/>
		<result column="att_sales" property="sales"/>
		<result column="att_star" property="star"/>
		<result column="att_price" property="price"/>
		<result column="att_discountprice" property="discountPrice"/>
		<result column="att_category" property="category"/>
		<result column="att_thumbnail" property="thumbnail"/>
		<result column="att_photo" property="photo"/>
		<result column="att_address" property="address"/>
		<result column="att_detailcontent" property="detail"/>
		<collection property="attOption" resultMap="AttrOptionMap" />
	</resultMap>
	
	<resultMap id="AttrOptionMap" type="com.nadri.attr.vo.AttOption">
		<result column="att_no" property="no"/>
		<result column="att_option" property="option"/>
		<result column="att_price" property="price"/>
		<result column="att_discountprice" property="discountPrice"/>
	</resultMap>

	<!-- 리스트 -->
	<select id="allAttrList" resultMap="AttrResultMap">
		<![CDATA[
		select
			att_no,
			att_name,
			att_content,
			att_startdate,
			att_enddate,
			att_place,
			att_sales,
			att_star,
			att_price,
			att_discountprice,
			att_category,
			att_thumbnail,
			att_photo
		from attraction
        where (att_enddate is null or att_enddate > sysdate)
		order by att_no desc]]>
	</select>
	
	<!-- 상품 수 -->
	<select id="attrcount" resultType="int">
		select count(*)
		from attraction
	</select>
	
	<!-- 카테고리 -->
	<select id="searchAttraction" parameterType="com.nadri.attr.vo.Search" resultMap="AttrResultMap">
		
		select *
		from (
		        select a.*
		        from attraction a
		        where att_place like '%' || #{place} || '%'
		        and (att_enddate is null or att_enddate > sysdate)
		        <if test="keyword != null">
		        	and (replace(att_name, ' ', '')  like '%' || #{keyword} || '%'
		        	or replace(att_content, ' ', '') like '%' || #{keyword} || '%')
		        </if>
		        <if test="category != null">
		        	and att_category like '%' || #{category} || '%'
		        </if>
		        <if test="startdate != null">
		        	and (att_startdate is null or to_char(#{startdate},'YYYY-MM-DD') &gt; att_startdate)
		        </if>
		        <if test="enddate != null">
		        	and (att_startdate is null or to_char(#{enddate},'YYYY-MM-DD') &lt; att_enddate)
		        </if>
		     )
		order by att_no desc
		
	</select>
	
	<select id="getSearchedRow" parameterType="com.nadri.attr.vo.Search" resultType="int">	
		select count(*)
		from (
		        select a.*
		        from attraction a
		        where att_place like '%' || #{place} || '%'
		        and (att_enddate is null or att_enddate > sysdate)
		        <if test="keyword != null">
		        	and (replace(att_name, ' ', '')  like '%' || #{keyword} || '%'
		        	or replace(att_content, ' ', '') like '%' || #{keyword} || '%')
		        </if>
		        <if test="category != null">
		        	and att_category like '%' || #{category} || '%'
		        </if>
		        <if test="startdate != null">
		        	and (att_startdate is null or to_char(#{startdate},'YYYY-MM-DD') &gt; att_startdate)
		        </if>
		        <if test="enddate != null">
		        	and (att_startdate is null or to_char(#{enddate},'YYYY-MM-DD') &lt; att_enddate)
		        </if>
		     )
		order by att_no desc
	</select>	
	
	<!-- 디테일페이지-설명/옵션 -->
	<select id="getDetailByNo" parameterType="int" resultMap="AttrResultMap">
		select  *
		from attraction 
		where att_no = #{no}
	</select>
	<select id="getOptionByNo" parameterType="int" resultMap="AttrOptionMap">
		select *
		from att_option
		where att_no = #{no}
	</select>
	
</mapper>